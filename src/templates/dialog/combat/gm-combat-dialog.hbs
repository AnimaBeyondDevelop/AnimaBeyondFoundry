<form class='{{cssClass}} gm-combat-dialog' autocomplete='off'>
  <div class='combatants'>
    {{#> "systems/animabf/templates/common/ui/group.hbs"
      class="attack-values"
    }}
      {{>
      "systems/animabf/templates/common/ui/group-header.hbs"
        title=(localize 'macros.combat.dialog.attacker.title')
      }}
      {{#> "systems/animabf/templates/common/ui/group-body.hbs"
        class="attack-values"
      }}
        <div class='combatant-profile'>
          <div class='image'>
            <img src='{{this.attacker.token.texture.src}}' data-edit='img' title='{{this.attacker.token.name}}' />
          </div>
          <p class='label name'>
            {{this.attacker.token.name}}
          </p>
        </div>

        {{#if this.attacker.isReady}}
          {{>
          "systems/animabf/templates/common/ui/vertical-titled-input.hbs"
            class="custom-modifier"
            title=(localize 'macros.combat.dialog.attackerCustomModifier.title')
            inputName="attacker.customModifier"
            inputValue=this.attacker.customModifier
          }}


          <p class='attack-type label'>
            {{localize (concat 'macros.combat.dialog.attackType.' this.attacker.result.type '.title')}}
          </p>
          <div class='values'>
            {{#if (is "eq" this.attacker.result.type 'combat')}}
              {{#unless this.attacker.result.values.unarmed}}
                {{>
                "systems/animabf/templates/common/ui/vertical-titled-input.hbs"
                  class="weapon-used"
                  title=(localize 'macros.combat.dialog.weaponUsed.title')
                  inputType="text"
                  disabled=true
                  inputValue=this.attacker.result.weapon.name
                }}
                {{>
                "systems/animabf/templates/common/ui/vertical-titled-input.hbs"
                  class="weapon-quality"
                  title=(localize 'macros.combat.dialog.weaponQuality.title')
                  inputType="text"
                  disabled=true
                  inputValue=this.attacker.result.weapon.system.quality.value
                }}
                {{>
                "systems/animabf/templates/common/ui/vertical-titled-input.hbs"
                  class="weapon-attack"
                  title=(localize 'macros.combat.dialog.weaponAttack.title')
                  inputType="text"
                  disabled=true
                  inputValue=this.attacker.result.values.attack
                }}
              {{else}}
                {{>
                "systems/animabf/templates/common/ui/vertical-titled-input.hbs"
                  class="weapon-used"
                  title=(localize 'macros.combat.dialog.weaponUsed.title')
                  inputType="text"
                  disabled=true
                  inputValue="Unarmed"
                }}
                {{>
                "systems/animabf/templates/common/ui/vertical-titled-input.hbs"
                  class="weapon-attack"
                  title=(localize 'macros.combat.dialog.attack.title')
                  inputType="text"
                  disabled=true
                  inputValue=this.attacker.result.values.attack
                }}
              {{/unless}}
            {{/if}}

            {{#if (is "eq" this.attacker.result.type 'mystic')}}
              {{>
              "systems/animabf/templates/common/ui/vertical-titled-input.hbs"
                class="spell-used"
                title=(concat (localize 'macros.combat.dialog.spell.title') ' - ' (localize (concat 'anima.ui.mystic.spell.grade.' this.attacker.result.values.spellGrade '.title')))
                inputType="text"
                disabled=true
                inputValue=this.attacker.result.spell.name
              }}
              {{>
              "systems/animabf/templates/common/ui/vertical-titled-input.hbs"
                class="magic-projection"
                title=(localize 'macros.combat.dialog.gm.projection.title')
                inputType="text"
                disabled=true
                inputValue=this.attacker.result.values.magicProjection
              }}
            {{/if}}

            {{#if (is "eq" this.attacker.result.type 'psychic')}}
              {{>
              "systems/animabf/templates/common/ui/vertical-titled-input.hbs"
                class="psychic-potential"
                title=(localize 'macros.combat.dialog.gm.psychicPotential.title')
                inputType="text"
                disabled=true
                inputValue=this.attacker.result.values.psychicPotential
              }}
              {{>
              "systems/animabf/templates/common/ui/vertical-titled-input.hbs"
                class="power-used"
                title=(localize 'macros.combat.dialog.gm.psychicPower.title')
                inputType="text"
                disabled=true
                inputValue=this.attacker.result.power.name
              }}
              {{>
              "systems/animabf/templates/common/ui/vertical-titled-input.hbs"
                class="psychic-projection"
                title=(localize 'macros.combat.dialog.gm.projection.title')
                inputType="text"
                disabled=true
                inputValue=this.attacker.result.values.psychicProjection
              }}
            {{/if}}

          </div>
          <div class='values'>

            {{#if (is "neq" this.attacker.result.values.critic '-')}}
              {{>
              "systems/animabf/templates/common/ui/vertical-titled-input.hbs"
                class="critic"
                title=(localize 'macros.combat.dialog.critic.title')
                inputType="text"
                disabled=true
                inputValue=(localize (concat 'anima.ui.combat.armors.at.' this.attacker.result.values.critic '.title'))
              }}
              {{>
              "systems/animabf/templates/common/ui/vertical-titled-input.hbs"
                class="damage"
                title=(localize 'macros.combat.dialog.damage.title')
                inputType="text"
                disabled=true
                inputValue=this.attacker.result.values.damage
              }}
            {{/if}}
            {{>
            "systems/animabf/templates/common/ui/vertical-titled-input.hbs"
              class="roll"
              title=(localize 'macros.combat.dialog.rolled.title')
              inputType="text"
              disabled=true
              inputValue=this.attacker.result.values.roll
            }}
            {{>
            "systems/animabf/templates/common/ui/vertical-titled-input.hbs"
              class="total"
              title=(localize 'macros.combat.dialog.total.title')
              inputType="text"
              disabled=true
              inputValue=this.attacker.result.values.total
            }}
          </div>
            <div class="combat-mod">
              {{#each this.attacker.result.values.attackerCombatMod as |attackerCombatMod|}}
                {{#unless (is "eq" attackerCombatMod.value 0)}}
                  {{>
                  "systems/animabf/templates/common/ui/horizontal-titled-input.hbs"
                    class="combatMod-value"
                    title=(localize (concat 'macros.combat.dialog.combatMod.' @key '.title'))
                    inputType="text"
                    disabled=true
                    inputValue=attackerCombatMod.value
                  }}
                  {{>
                  "systems/animabf/templates/common/ui/horizontal-titled-input.hbs"
                    class="combatMod-apply"
                    inputType="checkbox"
                    disabled=false
                    inputName=(concat "attacker.result.values.attackerCombatMod." @key ".apply")
                    inputValue=(is 'eq' attackerCombatMod.apply true)
                  }}
                {{/unless}}
              {{/each}}
            </div>
        {{else}}
          <div class='waiting-row'>
            {{>'systems/animabf/templates/common/ui/loading-indicator.hbs' class="big"}}
            <p class='label'>{{localize 'macros.combat.dialog.waitingAttack.title'}}</p>
          </div>
        {{/if}}
      {{/"systems/animabf/templates/common/ui/group-body.hbs"}}
    {{/"systems/animabf/templates/common/ui/group.hbs"}}

    <div class='versus-label'>
      <p class='label'>VS</p>
    </div>

    {{#> "systems/animabf/templates/common/ui/group.hbs"
      class="defender-values"
    }}
      {{>
      "systems/animabf/templates/common/ui/group-header.hbs"
        title=(localize 'macros.combat.dialog.defender.title')
      }}
      {{#> "systems/animabf/templates/common/ui/group-body.hbs"
        class="defender-values"
      }}
        <div class='combatant-profile'>
          <div class='image'>
            <img src='{{this.defender.token.texture.src}}' data-edit='img' title='{{this.defender.token.name}}' />
          </div>
          <p class='label name'>
            {{this.defender.token.name}}
          </p>
        </div>

        {{#if this.attacker.isReady}}
          {{#if this.defender.isReady}}
            {{#unless (is "eq" this.defender.result.type 'resistance')}}
              {{>
              "systems/animabf/templates/common/ui/vertical-titled-input.hbs"
                class="custom-modifier"
                title=(localize 'macros.combat.dialog.defenderCustomModifier.title')
                inputName="defender.customModifier"
                inputValue=this.defender.customModifier
              }}
            {{/unless}}

            <p class='defense-type label'>
              {{localize (concat 'macros.combat.dialog.attackType.' this.defender.result.type '.title')}}
            </p>

            <div class='values'>
              {{#if (is "eq" this.defender.result.type 'combat')}}
                {{>
                "systems/animabf/templates/common/ui/vertical-titled-input.hbs"
                  class="combat-defense-type"
                  inputType="text"
                  title=(localize 'macros.combat.dialog.defenseType.title')
                  disabled=true
                  inputValue=(localize (concat 'macros.combat.dialog.defenseType.' this.defender.result.values.type '.title'))
                }}
                {{#if (is 'eq' this.defender.result.values.type 'dodge')}}
                  {{>
                  "systems/animabf/templates/common/ui/vertical-titled-input.hbs"
                    class="dodge-value"
                    inputType="text"
                    title=(localize 'macros.combat.dialog.dodgeValue.title')
                    disabled=true
                    inputValue=this.defender.result.values.defense
                  }}
                {{else}}
                  {{>
                  "systems/animabf/templates/common/ui/vertical-titled-input.hbs"
                    class="block-value"
                    inputType="text"
                    title=(localize 'macros.combat.dialog.blockValue.title')
                    disabled=true
                    inputValue=this.defender.result.values.defense
                  }}
                {{/if}}
              {{/if}}

              {{#if (is "eq" this.defender.result.type 'mystic')}}
                {{>
                "systems/animabf/templates/common/ui/vertical-titled-input.hbs"
                  class="spell-used"
                title=(concat (localize 'macros.combat.dialog.spell.title') ' - ' (localize (concat 'anima.ui.mystic.spell.grade.' this.defender.result.values.spellGrade '.title')))
                  inputType="text"
                  disabled=true
                  inputValue=this.defender.result.spell.name
                }}
                {{>
                "systems/animabf/templates/common/ui/vertical-titled-input.hbs"
                  class="magic-projection"
                  title=(localize 'macros.combat.dialog.gm.projection.title')
                  inputType="text"
                  disabled=true
                  inputValue=this.defender.result.values.magicProjection
                }}
              {{/if}}

              {{#if (is "eq" this.defender.result.type 'psychic')}}
                {{#unless (is "eq" this.defender.result.values.psychicPotential 0)}}
                  {{>
                  "systems/animabf/templates/common/ui/vertical-titled-input.hbs"
                    class="psychic-potential"
                    title=(localize 'macros.combat.dialog.gm.psychicPotential.title')
                    inputType="text"
                    disabled=true
                    inputValue=this.defender.result.values.psychicPotential
                  }}
                {{/unless}}
                {{>
                "systems/animabf/templates/common/ui/vertical-titled-input.hbs"
                  class="power-used"
                  title=(localize 'macros.combat.dialog.gm.psychicPower.title')
                  inputType="text"
                  disabled=true
                  inputValue=this.defender.result.power.name
                }}
                {{>
                "systems/animabf/templates/common/ui/vertical-titled-input.hbs"
                  class="psychic-projection"
                  title=(localize 'macros.combat.dialog.gm.projection.title')
                  inputType="text"
                  disabled=true
                  inputValue=this.defender.result.values.psychicProjection
                }}
              {{/if}}
            </div>

            <div class='values'>
              {{#if (is 'neq' this.defender.result.values.at undefined)}}
                {{>
                "systems/animabf/templates/common/ui/vertical-titled-input.hbs"
                  class="at-value"
                  title=(localize 'macros.combat.dialog.at.title')
                  inputType="text"
                  disabled=true
                  inputValue=this.defender.result.values.at
                }}
              {{/if}}
              {{#if (is "eq" this.defender.result.type 'resistance')}}
                {{>
                "systems/animabf/templates/common/ui/horizontal-titled-input.hbs"
                  title=(localize 'macros.combat.dialog.surprised.title')
                  inputType="checkbox"
                  inputName="defender.result.values.surprised"
                  inputValue=(is 'eq' this.defender.result.values.surprised true)
                }}
              {{else}}
                {{>
                "systems/animabf/templates/common/ui/vertical-titled-input.hbs"
                  class="roll"
                  title=(localize 'macros.combat.dialog.rolled.title')
                  inputType="text"
                  disabled=true
                  inputValue=this.defender.result.values.roll
                }}
                {{>
                "systems/animabf/templates/common/ui/vertical-titled-input.hbs"
                  class="total"
                  title=(localize 'macros.combat.dialog.total.title')
                  inputType="text"
                  disabled=true
                  inputValue=this.defender.result.values.total
                }}
              {{/if}}
            </div>

            <div class="combat-mod">
              {{#each this.defender.result.values.defenderCombatMod as |defenderCombatMod|}}
                {{#unless (is "eq" defenderCombatMod.value 0)}}
                  {{>
                  "systems/animabf/templates/common/ui/horizontal-titled-input.hbs"
                    class="combatMod-value"
                    title=(localize (concat 'macros.combat.dialog.combatMod.' @key '.title'))
                    inputType="text"
                    disabled=true
                    inputValue=defenderCombatMod.value
                  }}
                  {{>
                  "systems/animabf/templates/common/ui/horizontal-titled-input.hbs"
                    class="combatMod-apply"
                    inputType="checkbox"
                    disabled=false
                    inputName=(concat "defender.result.values.defenderCombatMod." @key ".apply")
                    inputValue=(is 'eq' defenderCombatMod.apply true)
                  }}
                {{/unless}}
              {{/each}}
            </div>
            
            {{#if (is "eq" this.calculations.winner._id this.defender.token._id)}}
              {{#if (or (is "eq" this.defender.result.type 'psychic') (is "eq" this.defender.result.type 'mystic'))}}
              <div class="supernatural-shield">
                  {{>
                  "systems/animabf/templates/common/ui/horizontal-titled-input.hbs"
                    class="doble-damage"
                    title=(localize 'macros.combat.dialog.dobleDamage.title')
                    inputType="checkbox"
                    disabled=false
                    inputName="defender.supernaturalShield.dobleDamage"
                    inputValue=(is 'eq' this.defender.supernaturalShield.dobleDamage true)
                  }}
                  {{>
                  "systems/animabf/templates/common/ui/horizontal-titled-input.hbs"
                    class="immune-to-damage"
                    title=(localize 'macros.combat.dialog.immuneToDamage.title')
                    inputType="checkbox"
                    disabled=false
                    inputName="defender.supernaturalShield.immuneToDamage"
                    inputValue=(is 'eq' this.defender.supernaturalShield.immuneToDamage true)
                  }}
                </div>
              {{/if}}
            {{/if}}

          {{else}}
            {{#if (is 'gt' this.attacker.result.values.psychicFatigue 0)}}
              <div class='waiting-row'>
                <p class='label'>{{localize 'macros.combat.dialog.psychicFatigue.title'}}</p>
              </div>
              {{else}}
              <div class='waiting-row'>
                {{>'systems/animabf/templates/common/ui/loading-indicator.hbs' class="big"}}
                <p class='label'>{{localize 'macros.combat.dialog.waitingDefense.title'}}</p>
              </div>
            {{/if}}
          {{/if}}
        {{else}}
          <div class='waiting-row'>
            {{>'systems/animabf/templates/common/ui/loading-indicator.hbs' class="big"}}
            <p class='label'>{{localize 'macros.combat.dialog.waitingDefenseForAttack.title'}}</p>
          </div>
        {{/if}}
      {{/"systems/animabf/templates/common/ui/group-body.hbs"}}
    {{/"systems/animabf/templates/common/ui/group.hbs"}}
  </div>

  {{#if this.calculations}}
    {{#> "systems/animabf/templates/common/ui/group.hbs"
      class="combat-result"
    }}
      {{>
      "systems/animabf/templates/common/ui/group-header.hbs"
        title="Result"
      }}
      {{#> "systems/animabf/templates/common/ui/group-body.hbs"
        class="combat-result"
      }}
        <p class='label title'>{{concat this.calculations.winner.name
                                        (localize 'macros.combat.dialog.winner.title')}}</p>
        <div class='assault-values'>
          {{#if (is 'gt' this.roll.oppousedCheckRoll.attacker.value 0)}}
            {{>
            "systems/animabf/templates/common/ui/vertical-titled-input.hbs"
              class="oppoused-check-roll"
              title=(localize 'macros.combat.dialog.oppousedCheckRoll.title')
              disabled=true
              inputValue=this.roll.oppousedCheckRoll.attacker.value
            }}
          {{/if}}
          {{#if this.roll.criticRoll.sent}}
            {{>
            "systems/animabf/templates/common/ui/vertical-titled-input.hbs"
              class="critic-roll"
              title=(localize 'macros.combat.dialog.criticRoll.title')
              disabled=true
              inputValue=this.roll.criticRoll.value
            }}
          {{/if}}
          {{>
          "systems/animabf/templates/common/ui/vertical-titled-input.hbs"
            class="difference"
            title=(localize 'macros.combat.dialog.difference.title')
            inputType="text"
            disabled=true
            inputValue=this.calculations.difference
          }}
          {{#if (is 'gt' this.calculations.damage 0)}}
            {{>
            "systems/animabf/templates/common/ui/vertical-titled-input.hbs"
              class="damage-deal"
              title=(localize 'macros.combat.dialog.damageDeal.title')
              disabled=true
              inputValue=this.calculations.damage
            }}
          {{/if}}
          {{#if this.roll.resistanceRoll.sent}}
            {{>
            "systems/animabf/templates/common/ui/vertical-titled-input.hbs"
              class="resistance-roll"
              title=(localize 'macros.combat.dialog.resistanceRoll.title')
              disabled=true
              inputValue=this.roll.resistanceRoll.value
            }}
          {{/if}}
          {{#if (is 'gt' this.roll.oppousedCheckRoll.defender.value 0)}}
            {{>
            "systems/animabf/templates/common/ui/vertical-titled-input.hbs"
              class="oppoused-check-roll"
              title=(localize 'macros.combat.dialog.oppousedCheckRoll.title')
              disabled=true
              inputValue=this.roll.oppousedCheckRoll.defender.value
            }}
          {{/if}}
          {{#if this.calculations.canCounter}}
            {{#unless this.ui.isCounter}}
              {{>
              "systems/animabf/templates/common/ui/vertical-titled-input.hbs"
                class="counterattack-bonus"
                title=(localize 'macros.combat.dialog.counterAttackBonus.title')
                inputType="text"
                disabled=true
                inputValue=this.calculations.counterAttackBonus
              }}
            {{/unless}}
          {{/if}}
        </div>
        {{#if (is 'eq' this.ui.waitingRollRequest false)}}
          <div class='ready-buttons'>
            {{#if (or this.calculations.canCounter (is 'gt' this.calculations.damage 0))}}
              <button class='abf-button show-results'>
                {{localize 'macros.combat.dialog.showResultsButton.title'}}
              </button>
            {{/if}}
            {{#if this.calculations.canCounter}}
              {{#unless this.ui.isCounter}}
                <button title='{{localize 'macros.combat.dialog.counterAttackButtonTooltip.title'}}'
                        class='abf-button make-counter'>
                  {{localize 'macros.combat.dialog.counterAttackButton.title'}}
                </button>
              {{/unless}}
            {{/if}}
            {{#if (and this.roll.criticRoll.request (is 'eq' this.roll.resistanceRoll.request false))}}
              <button title='{{localize 'macros.combat.dialog.criticRollButtonTooltip.title'}}'
                      class='abf-button roll-critic'>
                {{localize 'macros.combat.dialog.criticRollButton.title'}}
              </button>
            {{/if}}
            {{#if this.roll.resistanceRoll.request}}
              <button title='{{localize 'macros.combat.dialog.rollResistanceButtonTooltip.title'}}'
                      class='abf-button roll-resistance'>
                  {{#if this.roll.criticRoll.sent}}
                    {{localize 'macros.combat.dialog.rollResistanceCriticButton.title'}}
                  {{else}}
                    {{localize 'macros.combat.dialog.rollResistanceButton.title'}}
                  {{/if}}
              </button>
            {{/if}}
            {{#if this.roll.oppousedCheckRoll.request}}
                <button title='{{localize 'macros.combat.dialog.rollOppousedCheckButtonTooltip.title'}}'
                        class='abf-button roll-oppoused-check'>
                  {{localize 'macros.combat.dialog.rollOppousedCheckButton.title'}}
                </button>
            {{/if}}
            {{#unless (or this.roll.resistanceRoll.request this.roll.oppousedCheckRoll.request this.roll.criticRoll.request)}}
              <button title='{{localize 'macros.combat.dialog.applyAndCloseButtonTooltip.title'}}'
                      class='abf-button apply-values'>
                {{localize 'macros.combat.dialog.applyAndCloseButton.title'}}
              </button>
            {{/unless}}
            <button class='abf-button cancel-button'>
              {{localize 'macros.combat.dialog.cancelButton.title'}}
            </button>
          </div>
          {{else}}
          <div class='roll-request-sent'>
            {{>'systems/animabf/templates/common/ui/loading-indicator.hbs' class="big"}}
            <p class='label'>
              {{localize 'macros.combat.dialog.waitingRollRequest.title'}}
            </p>
          </div>
        {{/if}}
      {{/"systems/animabf/templates/common/ui/group-body.hbs"}}
    {{/"systems/animabf/templates/common/ui/group.hbs"}}
  {{/if}}
</form>
